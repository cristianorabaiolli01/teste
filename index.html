<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÆSIR • cinza + análise</title>
    <style>
        /* ===== RESET — cinza com detalhes pretos ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --black-hole: #0A0A0A;        /* preto profundo - fundo */
            --graphite: #1E1E1E;           /* superfície primária */
            --forge: #2C2C2C;              /* elementos elevados */
            --iron: #3A3A3A;                /* bordas e divisórias */
            --dust: #5E5E5E;                /* textos secundários */
            --silver: #8A8A8A;               /* textos principais */
            --platinum: #BEBEBE;              /* destaques sutis */
            --glass: rgba(255, 255, 255, 0.02);
        }

        body {
            background: var(--black-hole);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--silver);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            -webkit-font-smoothing: antialiased;
        }

        /* container principal */
        .cassette {
            max-width: 400px;
            width: 100%;
            background: var(--graphite);
            border: 1px solid var(--iron);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9);
            position: relative;
            min-height: 700px;
        }

        /* ===== tipografia utilitária ===== */
        .micro {
            font-size: 0.6rem;
            letter-spacing: 0.2em;
            color: var(--dust);
            text-transform: uppercase;
        }

        /* ===== header ===== */
        .header-sec {
            padding: 28px 20px 16px;
            border-bottom: 1px solid var(--iron);
        }

        .user-marker {
            display: flex;
            justify-content: space-between;
            margin-bottom: 28px;
        }

        .user-code {
            font-size: 0.65rem;
            color: var(--dust);
            letter-spacing: 0.3em;
        }

        .dot {
            width: 6px;
            height: 6px;
            background: var(--iron);
        }

        .balance-block {
            margin: 12px 0 8px;
        }

        .value-large {
            font-size: 3rem;
            font-weight: 280;
            color: var(--platinum);
            line-height: 1;
            font-family: 'Inter', monospace;
            letter-spacing: -0.02em;
            transition: filter 0.2s;
            word-break: break-word;
        }

        .value-large.blur {
            filter: blur(8px);
        }

        .action-strip {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .action-btn {
            font-size: 0.55rem;
            color: var(--dust);
            letter-spacing: 0.15em;
            cursor: pointer;
            padding: 4px 0;
            border-bottom: 1px solid transparent;
            transition: 0.1s;
            -webkit-touch-callout: none;
        }

        .action-btn:active {
            color: var(--platinum);
            border-bottom-color: var(--platinum);
        }

        /* ===== métricas ===== */
        .metric-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--iron);
            margin: 16px 20px;
        }

        .metric-cell {
            background: var(--graphite);
            padding: 18px 12px;
        }

        .metric-label {
            font-size: 0.55rem;
            color: var(--dust);
            letter-spacing: 0.15em;
            margin-bottom: 6px;
        }

        .metric-figure {
            font-size: 1.8rem;
            font-weight: 260;
            color: var(--platinum);
            font-family: 'Inter', monospace;
        }

        .metric-figure.blur {
            filter: blur(5px);
        }

        /* ===== microfone ===== */
        .voice-chamber {
            margin: 8px 20px 24px;
            border: 1px solid var(--iron);
            background: var(--forge);
            padding: 20px 12px 16px;
        }

        .voice-prompt {
            font-size: 0.55rem;
            color: var(--dust);
            letter-spacing: 0.4em;
            text-align: center;
        }

        .mic-area {
            display: flex;
            justify-content: center;
            margin: 20px 0 12px;
        }

        .mic-button {
            width: 72px;
            height: 72px;
            border: 1px solid var(--iron);
            background: var(--graphite);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: 100;
            color: var(--dust);
            cursor: pointer;
            transition: 0.15s;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .mic-button:active {
            background: var(--iron);
            color: var(--platinum);
            transform: scale(0.97);
        }

        .mic-button.listening {
            background: var(--iron);
            border-color: var(--silver);
            animation: pulse-border 1.2s infinite;
        }

        @keyframes pulse-border {
            0% { border-color: var(--iron); }
            50% { border-color: var(--silver); }
            100% { border-color: var(--iron); }
        }

        .voice-status-text {
            font-size: 0.6rem;
            color: var(--dust);
            text-align: center;
            min-height: 18px;
        }

        .voice-feedback-text {
            font-size: 0.7rem;
            color: var(--silver);
            text-align: center;
            border-top: 1px dashed var(--iron);
            margin-top: 16px;
            padding-top: 14px;
            min-height: 50px;
            font-style: normal;
            word-break: break-word;
        }

        /* ===== extrato ===== */
        .ledger-box {
            margin: 16px 20px 80px;
            border-top: 1px solid var(--iron);
            padding-top: 14px;
        }

        .ledger-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.55rem;
            color: var(--dust);
            letter-spacing: 0.2em;
            margin-bottom: 10px;
        }

        .trans-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid var(--forge);
            cursor: default;
            position: relative;
        }

        .trans-desc-block {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .trans-desc {
            font-size: 0.8rem;
            color: var(--silver);
            font-weight: 300;
        }

        .trans-cat {
            font-size: 0.55rem;
            color: var(--dust);
        }

        .trans-value {
            font-size: 0.95rem;
            color: var(--platinum);
            font-family: 'Inter', monospace;
            margin-right: 12px;
        }

        .trans-value.income {
            color: var(--platinum);
        }

        .trans-value.expense {
            color: var(--dust);
        }

        /* botão de remover individual */
        .remove-trans-btn {
            background: transparent;
            border: 1px solid var(--iron);
            color: var(--dust);
            font-size: 0.7rem;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.1s;
            font-family: 'Inter', monospace;
            padding: 0;
            line-height: 1;
            -webkit-tap-highlight-color: transparent;
        }

        .remove-trans-btn:active {
            background: var(--iron);
            color: var(--platinum);
            border-color: var(--silver);
        }

        .trans-row:hover .remove-trans-btn {
            opacity: 1;
        }

        .empty-ledger {
            text-align: center;
            padding: 32px 0;
            color: var(--iron);
            font-size: 0.7rem;
            letter-spacing: 0.1em;
        }

        /* ===== ABA ANÁLISE ===== */
        .analysis-box {
            margin: 16px 20px 80px;
            border-top: 1px solid var(--iron);
            padding-top: 14px;
            display: none;
        }

        .analysis-box.active {
            display: block;
        }

        .analysis-header {
            font-size: 0.55rem;
            color: var(--dust);
            letter-spacing: 0.2em;
            margin-bottom: 20px;
        }

        .analysis-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--forge);
        }

        .analysis-label {
            font-size: 0.75rem;
            color: var(--silver);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .analysis-value {
            font-size: 1rem;
            color: var(--platinum);
            font-family: 'Inter', monospace;
        }

        .analysis-value.positive {
            color: var(--platinum);
        }

        .analysis-value.negative {
            color: var(--dust);
        }

        .analysis-category-bar {
            margin: 12px 0;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--forge);
        }

        .category-name {
            width: 70px;
            font-size: 0.7rem;
            color: var(--silver);
            text-transform: uppercase;
        }

        .category-bar-bg {
            flex: 1;
            height: 4px;
            background: var(--forge);
            position: relative;
        }

        .category-bar-fill {
            height: 4px;
            background: var(--platinum);
            width: 0%;
        }

        .category-value {
            font-size: 0.75rem;
            color: var(--dust);
            font-family: 'Inter', monospace;
            min-width: 70px;
            text-align: right;
        }

        /* ===== barra inferior ===== */
        .bottom-strip {
            background: var(--graphite);
            border-top: 1px solid var(--iron);
            display: flex;
            justify-content: space-around;
            padding: 8px 16px 12px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 400px;
            margin: 0 auto;
        }

        .nav-unit {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--dust);
            font-size: 0.55rem;
            letter-spacing: 0.15em;
            padding: 6px 8px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-unit.active {
            color: var(--platinum);
        }

        .nav-marker {
            width: 4px;
            height: 4px;
            background: currentColor;
        }

        .fab-mini {
            width: 48px;
            height: 48px;
            background: var(--forge);
            border: 1px solid var(--iron);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            color: var(--silver);
            margin-top: -24px;
            cursor: pointer;
            transition: 0.1s;
            -webkit-tap-highlight-color: transparent;
        }

        .fab-mini:active {
            background: var(--iron);
            color: var(--platinum);
            transform: scale(0.96);
        }

        /* overlay de entrada */
        .init-shroud {
            position: fixed;
            inset: 0;
            background: var(--black-hole);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.6s;
            padding: 20px;
        }

        .init-card {
            max-width: 300px;
            width: 100%;
            background: var(--graphite);
            border: 1px solid var(--iron);
            padding: 28px 20px;
            text-align: center;
        }

        .init-title {
            font-size: 1.2rem;
            color: var(--platinum);
            letter-spacing: 0.3em;
            font-weight: 280;
            margin-bottom: 20px;
        }

        .enter-btn {
            background: transparent;
            border: 1px solid var(--iron);
            color: var(--silver);
            padding: 14px 20px;
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            width: 100%;
            cursor: pointer;
            transition: 0.1s;
        }

        .enter-btn:active {
            background: var(--forge);
            color: var(--platinum);
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="welcomeOverlay" class="init-shroud">
        <div class="init-card">
            <div class="init-title">ÆSIR</div>
            <div style="color: var(--dust); font-size:0.6rem; margin:16px 0;">cinza · análise</div>
            <button class="enter-btn" id="startAppBtn">ACESSAR</button>
        </div>
    </div>

    <div class="cassette" id="mainApp">
        <header class="header-sec">
            <div class="user-marker">
                <span class="user-code">⌨️ operador_07</span>
                <span class="dot"></span>
            </div>
            <div class="balance-block">
                <div class="micro">saldo</div>
                <div class="value-large" id="balanceDisplay">R$ 0,00</div>
            </div>
            <div class="action-strip">
                <span class="action-btn" id="toggleBlurBtn">[ ocultar ]</span>
                <span class="action-btn" id="clearAllBtn">[ limpar tudo ]</span>
                <span class="action-btn" id="monthBtn">[ dezembro ]</span>
            </div>
        </header>

        <div class="metric-panel">
            <div class="metric-cell">
                <div class="metric-label">receita</div>
                <div class="metric-figure" id="incomeMetric">R$ 0,00</div>
            </div>
            <div class="metric-cell">
                <div class="metric-label">despesa</div>
                <div class="metric-figure" id="expenseMetric">R$ 0,00</div>
            </div>
        </div>

        <div class="voice-chamber">
            <div class="voice-prompt">> entrada de voz <</div>
            <div class="mic-area">
                <div class="mic-button" id="micButton">⌥</div>
            </div>
            <div class="voice-status-text" id="micStatus">standby</div>
            <div class="voice-feedback-text" id="micFeedback"></div>
        </div>

        <!-- ABA INÍCIO (extrato) -->
        <div id="homeTab" class="ledger-box">
            <div class="ledger-header">
                <span>movimento</span>
                <span>valor</span>
            </div>
            <div id="transactionsContainer">
                <div class="empty-ledger">— nenhum registro —</div>
            </div>
        </div>

        <!-- ABA ANÁLISE -->
        <div id="analysisTab" class="analysis-box">
            <div class="analysis-header">> resumo do período <</div>
            
            <div class="analysis-row">
                <span class="analysis-label">total receitas</span>
                <span class="analysis-value positive" id="analysisIncome">R$ 0,00</span>
            </div>
            <div class="analysis-row">
                <span class="analysis-label">total despesas</span>
                <span class="analysis-value negative" id="analysisExpense">R$ 0,00</span>
            </div>
            <div class="analysis-row">
                <span class="analysis-label">saldo líquido</span>
                <span class="analysis-value" id="analysisBalance">R$ 0,00</span>
            </div>
            <div class="analysis-row">
                <span class="analysis-label">transações</span>
                <span class="analysis-value" id="analysisCount">0</span>
            </div>
            
            <div style="margin-top: 32px;">
                <div class="analysis-header">> categorias <</div>
                <div id="categoriesContainer">
                    <div class="category-item">
                        <span class="category-name">alim.</span>
                        <div class="category-bar-bg">
                            <div class="category-bar-fill" id="catAlimBar" style="width: 0%"></div>
                        </div>
                        <span class="category-value" id="catAlimValue">R$ 0</span>
                    </div>
                    <div class="category-item">
                        <span class="category-name">transp</span>
                        <div class="category-bar-bg">
                            <div class="category-bar-fill" id="catTranspBar" style="width: 0%"></div>
                        </div>
                        <span class="category-value" id="catTranspValue">R$ 0</span>
                    </div>
                    <div class="category-item">
                        <span class="category-name">morad</span>
                        <div class="category-bar-bg">
                            <div class="category-bar-fill" id="catMoradBar" style="width: 0%"></div>
                        </div>
                        <span class="category-value" id="catMoradValue">R$ 0</span>
                    </div>
                    <div class="category-item">
                        <span class="category-name">outros</span>
                        <div class="category-bar-bg">
                            <div class="category-bar-fill" id="catOutrosBar" style="width: 0%"></div>
                        </div>
                        <span class="category-value" id="catOutrosValue">R$ 0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-strip">
            <div class="nav-unit" id="navHome">
                <span class="nav-marker"></span>início
            </div>
            <div class="nav-unit" id="navAnalysis">
                <span class="nav-marker"></span>análise
            </div>
            <div class="fab-mini" id="fabMic">+</div>
            <div class="nav-unit" id="navArchive">
                <span class="nav-marker"></span>arquivo
            </div>
            <div class="nav-unit" id="navSystem">
                <span class="nav-marker"></span>sistema
            </div>
        </div>
    </div>

    <script>
        (function() {
            "use strict";

            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOM carregado, inicializando...');

                // ---------- DADOS ----------
                let transactions = [];
                try {
                    const saved = localStorage.getItem('aesir_ledger_v3');
                    if (saved) {
                        transactions = JSON.parse(saved);
                        console.log('transações carregadas:', transactions.length);
                    }
                } catch (e) {
                    console.warn('erro ao carregar localStorage', e);
                }

                let hiddenMode = false;
                let listeningActive = false;
                let recognition = null;
                let synth = window.speechSynthesis;
                let voicePreferred = null;
                let currentTab = 'home'; // home ou analysis

                // ---------- REFERÊNCIAS DOM ----------
                const balanceEl = document.getElementById('balanceDisplay');
                const incomeEl = document.getElementById('incomeMetric');
                const expenseEl = document.getElementById('expenseMetric');
                const transContainer = document.getElementById('transactionsContainer');
                const micButton = document.getElementById('micButton');
                const fabMic = document.getElementById('fabMic');
                const micStatus = document.getElementById('micStatus');
                const micFeedback = document.getElementById('micFeedback');
                const toggleBlurBtn = document.getElementById('toggleBlurBtn');
                const clearAllBtn = document.getElementById('clearAllBtn');
                const monthBtn = document.getElementById('monthBtn');
                const welcomeOverlay = document.getElementById('welcomeOverlay');
                const startBtn = document.getElementById('startAppBtn');
                const homeTab = document.getElementById('homeTab');
                const analysisTab = document.getElementById('analysisTab');
                const navHome = document.getElementById('navHome');
                const navAnalysis = document.getElementById('navAnalysis');
                const navArchive = document.getElementById('navArchive');
                const navSystem = document.getElementById('navSystem');

                // elementos da análise
                const analysisIncome = document.getElementById('analysisIncome');
                const analysisExpense = document.getElementById('analysisExpense');
                const analysisBalance = document.getElementById('analysisBalance');
                const analysisCount = document.getElementById('analysisCount');
                const catAlimValue = document.getElementById('catAlimValue');
                const catTranspValue = document.getElementById('catTranspValue');
                const catMoradValue = document.getElementById('catMoradValue');
                const catOutrosValue = document.getElementById('catOutrosValue');
                const catAlimBar = document.getElementById('catAlimBar');
                const catTranspBar = document.getElementById('catTranspBar');
                const catMoradBar = document.getElementById('catMoradBar');
                const catOutrosBar = document.getElementById('catOutrosBar');

                // ---------- FORMATAÇÃO ----------
                function formatCurrency(val) {
                    return 'R$ ' + val.toFixed(2).replace('.', ',');
                }

                // ---------- ATUALIZAR UI (ambas as abas) ----------
                function updateUI() {
                    const income = transactions.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
                    const expense = transactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
                    const balance = income - expense;

                    // elementos principais
                    if (balanceEl) balanceEl.textContent = formatCurrency(balance);
                    if (incomeEl) incomeEl.textContent = formatCurrency(income);
                    if (expenseEl) expenseEl.textContent = formatCurrency(expense);

                    // blur
                    [balanceEl, incomeEl, expenseEl].forEach(el => {
                        if (!el) return;
                        if (hiddenMode) el.classList.add('blur');
                        else el.classList.remove('blur');
                    });

                    // atualizar análise
                    if (analysisIncome) analysisIncome.textContent = formatCurrency(income);
                    if (analysisExpense) analysisExpense.textContent = formatCurrency(expense);
                    if (analysisBalance) analysisBalance.textContent = formatCurrency(balance);
                    if (analysisCount) analysisCount.textContent = transactions.length;

                    // categorias (baseado em palavras-chave)
                    let catAlim = 0, catTransp = 0, catMorad = 0, catOutros = 0;
                    
                    transactions.forEach(t => {
                        if (t.type === 'expense') {
                            const desc = (t.description || '').toLowerCase();
                            if (desc.includes('almoço') || desc.includes('jantar') || desc.includes('mercado') || desc.includes('alim') || desc.includes('comida') || desc.includes('restaurante')) {
                                catAlim += t.amount;
                            } else if (desc.includes('uber') || desc.includes('taxi') || desc.includes('gasolina') || desc.includes('transp') || desc.includes('ônibus') || desc.includes('metrô')) {
                                catTransp += t.amount;
                            } else if (desc.includes('aluguel') || desc.includes('luz') || desc.includes('água') || desc.includes('gás') || desc.includes('morad') || desc.includes('condomínio')) {
                                catMorad += t.amount;
                            } else {
                                catOutros += t.amount;
                            }
                        }
                    });

                    const totalDespesas = catAlim + catTransp + catMorad + catOutros;

                    if (catAlimValue) catAlimValue.textContent = formatCurrency(catAlim);
                    if (catTranspValue) catTranspValue.textContent = formatCurrency(catTransp);
                    if (catMoradValue) catMoradValue.textContent = formatCurrency(catMorad);
                    if (catOutrosValue) catOutrosValue.textContent = formatCurrency(catOutros);

                    // barras percentuais
                    if (catAlimBar) catAlimBar.style.width = (totalDespesas > 0 ? (catAlim / totalDespesas) * 100 : 0) + '%';
                    if (catTranspBar) catTranspBar.style.width = (totalDespesas > 0 ? (catTransp / totalDespesas) * 100 : 0) + '%';
                    if (catMoradBar) catMoradBar.style.width = (totalDespesas > 0 ? (catMorad / totalDespesas) * 100 : 0) + '%';
                    if (catOutrosBar) catOutrosBar.style.width = (totalDespesas > 0 ? (catOutros / totalDespesas) * 100 : 0) + '%';

                    // lista de transações com botão remover
                    if (!transContainer) return;

                    if (transactions.length === 0) {
                        transContainer.innerHTML = '<div class="empty-ledger">— nenhum registro —</div>';
                        return;
                    }

                    let html = '';
                    transactions.slice(0, 20).forEach((t, index) => {
                        let cat = 'outro';
                        if (t.description) {
                            const descLower = t.description.toLowerCase();
                            if (descLower.includes('almoço') || descLower.includes('jantar') || descLower.includes('mercado')) cat = 'alim.';
                            else if (descLower.includes('uber') || descLower.includes('gasolina')) cat = 'transp';
                            else if (descLower.includes('aluguel') || descLower.includes('luz')) cat = 'morad';
                        }
                        const sign = t.type === 'income' ? '' : '−';
                        const transId = t.id || 'temp_' + Date.now() + '_' + index;
                        html += `
                            <div class="trans-row" data-trans-id="${transId}">
                                <div class="trans-desc-block">
                                    <span class="trans-desc">${(t.description || 'movimento').substring(0, 22)}</span>
                                    <span class="trans-cat">${cat}</span>
                                </div>
                                <div class="trans-value ${t.type}">${sign} ${formatCurrency(t.amount)}</div>
                                <button class="remove-trans-btn" data-remove-id="${transId}" title="remover">✕</button>
                            </div>
                        `;
                    });
                    transContainer.innerHTML = html;

                    // adicionar eventos aos botões de remover
                    document.querySelectorAll('.remove-trans-btn').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const id = this.getAttribute('data-remove-id');
                            if (id) {
                                removeTransactionById(id);
                            }
                        });
                    });
                }

                // ---------- REMOVER TRANSAÇÃO POR ID ----------
                function removeTransactionById(id) {
                    const index = transactions.findIndex(t => t.id == id);
                    if (index !== -1) {
                        transactions.splice(index, 1);
                        saveTransactions();
                        speak('removido');
                    }
                }

                // ---------- PERSISTÊNCIA ----------
                function saveTransactions() {
                    try {
                        localStorage.setItem('aesir_ledger_v3', JSON.stringify(transactions));
                    } catch (e) {}
                    updateUI();
                }

                // ---------- ADICIONAR TRANSAÇÃO ----------
                function addTransaction(type, amount, description) {
                    const newTrans = {
                        id: Date.now() + '_' + Math.random().toString(36).substring(2, 6),
                        type: type,
                        amount: amount,
                        description: description.substring(0, 24) || (type === 'income' ? 'receita' : 'despesa'),
                        date: new Date().toLocaleDateString('pt-BR')
                    };
                    transactions.unshift(newTrans);
                    saveTransactions();
                }

                // ---------- LIMPAR TUDO ----------
                function clearAllTransactions() {
                    if (transactions.length > 0 && confirm('apagar todo o registro?')) {
                        transactions = [];
                        saveTransactions();
                        speak('registro limpo');
                    }
                }

                // ---------- VOZ ----------
                function loadVoices() {
                    const voices = synth.getVoices();
                    voicePreferred = voices.find(v => v.lang.includes('pt-BR')) || voices.find(v => v.lang.includes('pt')) || voices[0];
                }
                loadVoices();
                if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = loadVoices;

                function speak(text) {
                    if (!synth) return;
                    synth.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'pt-BR';
                    utterance.rate = 0.9;
                    if (voicePreferred) utterance.voice = voicePreferred;
                    synth.speak(utterance);
                }

                // ---------- RECONHECIMENTO ----------
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognition = new SR();
                    recognition.lang = 'pt-BR';
                    recognition.continuous = false;
                    recognition.interimResults = true;

                    recognition.onstart = function() {
                        listeningActive = true;
                        micButton?.classList.add('listening');
                        if (micStatus) micStatus.textContent = '> ouvindo <';
                    };

                    recognition.onend = function() {
                        listeningActive = false;
                        micButton?.classList.remove('listening');
                        if (micStatus) micStatus.textContent = 'standby';
                        setTimeout(() => {
                            if (micFeedback) micFeedback.textContent = '';
                        }, 2000);
                    };

                    recognition.onerror = function() {
                        listeningActive = false;
                        micButton?.classList.remove('listening');
                        if (micStatus) micStatus.textContent = 'falha';
                    };

                    recognition.onresult = function(event) {
                        const last = event.results[event.results.length - 1];
                        const transcript = last[0].transcript;
                        if (micFeedback) micFeedback.textContent = '> ' + transcript + ' <';
                        if (last.isFinal) {
                            processVoiceCommand(transcript);
                        }
                    };
                }

                function processVoiceCommand(cmd) {
                    const lower = cmd.toLowerCase();
                    
                    let amount = null;
                    const numberMap = {
                        'zero':0,'um':1,'dois':2,'três':3,'tres':3,'quatro':4,'cinco':5,
                        'seis':6,'sete':7,'oito':8,'nove':9,'dez':10,'onze':11,'doze':12,
                        'treze':13,'quatorze':14,'quinze':15,'vinte':20,'trinta':30,
                        'quarenta':40,'cinquenta':50,'sessenta':60,'setenta':70,'oitenta':80,
                        'noventa':90,'cem':100,'cento':100,'duzentos':200,'trezentos':300
                    };
                    
                    let parsedText = lower;
                    for (let [word, num] of Object.entries(numberMap)) {
                        parsedText = parsedText.replace(new RegExp('\\b' + word + '\\b', 'g'), num);
                    }
                    
                    const matches = parsedText.match(/\d+/g);
                    if (matches) amount = parseInt(matches[0], 10);

                    const isIncome = /recebi|ganhei|salário|salario|entrada/i.test(lower);
                    const type = isIncome ? 'income' : 'expense';

                    let desc = cmd
                        .replace(/\d+\s*mil/gi, '')
                        .replace(/\d+/g, '')
                        .replace(/reais?/gi, '')
                        .replace(/r\$/gi, '')
                        .replace(/\b(gastei|paguei|comprei|recebi|ganhei|de|com|em|para|um|uma|o|a)\b/gi, '')
                        .trim()
                        .replace(/\s+/g, ' ');

                    if (!desc || desc.length < 2) desc = type === 'income' ? 'receita' : 'despesa';

                    if (amount && amount > 0) {
                        addTransaction(type, amount, desc);
                        speak(`registrado ${formatCurrency(amount)}`);
                        if (micStatus) micStatus.textContent = '✓ registrado';
                    } else {
                        speak('valor não identificado');
                        if (micStatus) micStatus.textContent = '? não entendi';
                    }
                }

                function toggleListening() {
                    if (!recognition) {
                        speak('voz não disponível');
                        return;
                    }
                    if (listeningActive) {
                        recognition.stop();
                    } else {
                        try {
                            recognition.start();
                        } catch (e) {}
                    }
                }

                // ---------- TROCA DE ABAS ----------
                function setActiveTab(tab) {
                    currentTab = tab;
                    if (tab === 'home') {
                        homeTab.classList.add('active');
                        analysisTab.classList.remove('active');
                        navHome.classList.add('active');
                        navAnalysis.classList.remove('active');
                        navArchive.classList.remove('active');
                        navSystem.classList.remove('active');
                    } else if (tab === 'analysis') {
                        homeTab.classList.remove('active');
                        analysisTab.classList.add('active');
                        navHome.classList.remove('active');
                        navAnalysis.classList.add('active');
                        navArchive.classList.remove('active');
                        navSystem.classList.remove('active');
                    }
                }

                // ---------- EVENTOS ----------
                // Overlay
                if (startBtn && welcomeOverlay) {
                    startBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        welcomeOverlay.style.opacity = '0';
                        setTimeout(function() {
                            welcomeOverlay.style.display = 'none';
                            setTimeout(function() {
                                const hour = new Date().getHours();
                                const greet = hour < 12 ? 'bom dia' : hour < 18 ? 'boa tarde' : 'boa noite';
                                let msg = `${greet}, sistema cinza.`;
                                if (transactions.length) {
                                    msg += ` ${transactions.length} movimentos.`;
                                } else {
                                    msg += ' toque no microfone para comandar.';
                                }
                                speak(msg);
                            }, 300);
                        }, 600);
                    });
                } else {
                    if (welcomeOverlay) welcomeOverlay.style.display = 'none';
                }

                // microfones
                if (micButton) micButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    toggleListening();
                });

                if (fabMic) fabMic.addEventListener('click', function(e) {
                    e.preventDefault();
                    toggleListening();
                });

                // ocultar valores
                if (toggleBlurBtn) {
                    toggleBlurBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        hiddenMode = !hiddenMode;
                        updateUI();
                        toggleBlurBtn.textContent = hiddenMode ? '[ mostrar ]' : '[ ocultar ]';
                    });
                }

                // limpar tudo
                if (clearAllBtn) {
                    clearAllBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        clearAllTransactions();
                    });
                }

                // mês
                if (monthBtn) {
                    monthBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        speak('dezembro');
                    });
                }

                // navegação
                if (navHome) {
                    navHome.addEventListener('click', function(e) {
                        e.preventDefault();
                        setActiveTab('home');
                    });
                }

                if (navAnalysis) {
                    navAnalysis.addEventListener('click', function(e) {
                        e.preventDefault();
                        setActiveTab('analysis');
                    });
                }

                if (navArchive) {
                    navArchive.addEventListener('click', function(e) {
                        e.preventDefault();
                        speak('arquivo');
                    });
                }

                if (navSystem) {
                    navSystem.addEventListener('click', function(e) {
                        e.preventDefault();
                        speak('sistema');
                    });
                }

                // inicializar UI e aba padrão
                setActiveTab('home');
                updateUI();

                // dados de exemplo para teste (comente se quiser)
                if (transactions.length === 0) {
                    addTransaction('expense', 4500, 'aluguel');
                    addTransaction('expense', 8900, 'supermercado');
                    addTransaction('expense', 3200, 'uber');
                    addTransaction('income', 45000, 'salário');
                }
            }); 
        })();
    </script>
</body>
</html>
